<?php

/**
 * @license LGPLv3, http://opensource.org/licenses/LGPL-3.0
 * @copyright Metaways Infosystems GmbH, 2013
 * @copyright Aimeos (aimeos.org), 2015
 */

$enc = $this->encoder();

try {
	$addrArray = $this->standardBasket->getAddress( MShop_Order_Item_Base_Address_Abstract::TYPE_PAYMENT )->toArray();
} catch( Exception $e ) {
	$addrArray = array();
}

$billingDefault = ( isset( $this->addressCustomerItem ) ? $this->addressCustomerItem->getId() : 'null' );
$billingOption = $this->param( 'ca_billingoption', ( isset( $addrArray['order.base.address.addressid'] ) && $addrArray['order.base.address.addressid'] != '' ? $addrArray['order.base.address.addressid'] : $billingDefault ) );

$billingSalutations = $this->get( 'billingSalutations', array() );
$billingCountries = $this->get( 'addressCountries', array() );
$billingStates = $this->get( 'addressStates', array() );
$billingLanguages = $this->get( 'addressLanguages', array() );

$paymentCssAll = array();

foreach( $this->get( 'billingMandatory', array() ) as $name ) {
	$paymentCssAll[$name][] = 'mandatory';
}

foreach( $this->get( 'billingOptional', array() ) as $name ) {
	$paymentCssAll[$name][] = 'optional';
}

foreach( $this->get( 'billingHidden', array() ) as $name ) {
	$paymentCssAll[$name][] = 'hidden';
}

?>
<div class="checkout-standard-address-billing">
	<h2><?php echo $enc->html( $this->translate( 'client/html', 'Billing address' ), $enc::TRUST ); ?></h2>
<?php if( isset( $this->addressCustomerItem )  ) : ?>
	<div class="item-address">
		<div class="header">
			<input type="radio" name="<?php echo $enc->attr( $this->formparam( array( 'ca_billingoption' ) ) ); ?>" value="<?php echo $enc->attr( $this->addressCustomerItem->getId() ); ?>" <?php echo ( $billingOption == $this->addressCustomerItem->getId() ? 'checked="checked"' : '' ); ?> />
			<div class="values">
<?php
		$addr = $this->addressCustomerItem->getPaymentAddress();
		$id = $this->addressCustomerItem->getId();

		echo preg_replace( "/\n+/m", "<br/>", trim( $enc->html( sprintf(
			/// Address format with company (%1$s), salutation (%2$s), title (%3$s), first name (%4$s), last name (%5$s),
			/// address part one (%6$s, e.g street), address part two (%7$s, e.g house number), address part three (%8$s, e.g additional information),
			/// postal/zip code (%9$s), city (%10$s), state (%11$s), country (%12$s), language (%13$s),
			/// e-mail (%14$s), phone (%15$s), facsimile/telefax (%16$s), web site (%17$s), vatid (%18$s)
			$this->translate( 'client/html', '%1$s
%2$s %3$s %4$s %5$s
%6$s %7$s
%8$s
%9$s %10$s
%11$s
%12$s
%13$s
%14$s
%15$s
%16$s
%17$s
%18$s
'
			),
			$addr->getCompany(),
			( !in_array( $addr->getSalutation(), array( 'company' ) ) ? $this->translate( 'client/html/code', $addr->getSalutation() ) : '' ),
			$addr->getTitle(),
			$addr->getFirstName(),
			$addr->getLastName(),
			$addr->getAddress1(),
			$addr->getAddress2(),
			$addr->getAddress3(),
			$addr->getPostal(),
			$addr->getCity(),
			$addr->getState(),
			$this->translate( 'client/html/country', $addr->getCountryId() ),
			$this->translate( 'client/html/language', $addr->getLanguageId() ),
			$addr->getEmail(),
			$addr->getTelephone(),
			$addr->getTelefax(),
			$addr->getWebsite(),
			$addr->getVatID()
		) ) ) );
?>
			</div>
		</div>
<?php
		$paymentCss = $paymentCssAll;
		if( $billingOption == $id )
		{
			foreach( $this->get( 'billingError', array() ) as $name => $msg ) {
				$paymentCss[$name][] = 'error';
			}
		}

		$addrValues = $addr->toArray();

		if( !isset( $addrValues['order.base.address.languageid'] ) || $addrValues['order.base.address.languageid'] == '' ) {
			$addrValues['order.base.address.languageid'] = $this->get( 'billingLanguage', 'en' );
		}

		$values = array(
			'address' => $addrValues,
			'salutations' => $billingSalutations,
			'languages' => $billingLanguages,
			'countries' => $billingCountries,
			'states' => $billingStates,
			'type' => 'billing',
			'css' => $paymentCss,
			'id' => $id,
		);

		/** client/html/common/partials/address
		 * Relative path to the address partial template file
		 *
		 * Partials are templates which are reused in other templates and generate
		 * reoccuring blocks filled with data from the assigned values. The address
		 * partial creates an HTML block with input fields for address forms.
		 *
		 * The partial template files are usually stored in the layouts/partials/ folder
		 * of the core or the extensions. The configured path to the partial file must
		 * be relative to the layouts/ folder, e.g. "partials/address-default.html". 
		 *
		 * @param string Relative path to the template file
		 * @since 2015.04
		 * @category Developer
		 * @category User
		 */
?>
<?=		$this->partial( 'client/html/common/partials/address', 'common/partials/address-default.html', $values ); ?> 
	</div>
<?php endif; ?>
<?php if( $this->config( 'client/html/common/address/billing/disable-new', false ) === false ) : ?>
	<div class="item-address item-new" data-option="<?php echo $enc->attr( $billingOption ); ?>">
		<div class="header">
			<input type="radio" name="<?php echo $enc->attr( $this->formparam( array( 'ca_billingoption' ) ) ); ?>" value="null" <?php echo ( $billingOption == 'null' ? 'checked="checked"' : '' ); ?> />
			<div class="values"><span class="value value-new"><?php echo $enc->html( $this->translate( 'client/html', 'new address' ), $enc::TRUST ); ?></span></div>
		</div>
<?php
		$paymentCss = $paymentCssAll;
		if( $billingOption == 'null' )
		{
			foreach( $this->get( 'billingError', array() ) as $name => $msg ) {
				$paymentCss[$name][] = 'error';
			}
		}

		$addrValues = array_merge( $addrArray, $this->param( 'ca_billing', array() ) );

		if( !isset( $addrValues['order.base.address.languageid'] ) || $addrValues['order.base.address.languageid'] == '' ) {
			$addrValues['order.base.address.languageid'] = $this->get( 'billingLanguage', 'en' );
		}

		$values = array(
			'address' => $addrValues,
			'salutations' => $billingSalutations,
			'languages' => $billingLanguages,
			'countries' => $billingCountries,
			'states' => $billingStates,
			'type' => 'billing',
			'css' => $paymentCss,
		);
?>
<?=		$this->partial( 'client/html/common/partials/address', 'common/partials/address-default.html', $values ); ?> 
	</div>
<?php endif; ?>
<?php echo $this->get( 'billingBody' ); ?>
</div>